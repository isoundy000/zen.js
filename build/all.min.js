function cos(t){switch(t){case HalfPI:case-PacPI:return 0;case PI:case-PI:return-1;case PacPI:case-HalfPI:return 0;default:return Math.cos(t)}}function sin(t){switch(t){case HalfPI:case-PacPI:return 1;case PI:case-PI:return 0;case PacPI:case-HalfPI:return-1;default:return Math.sin(t)}}function isPowerOfTwo(t){return 0===(t&t-1)}var RENDER_CMD={TEXTURE:0,RECT:1,BLEND:2,FILTERS_PUSH:3,FILTERS_POP:4,MASK_PUSH:5,MASK_POP:6},DISPLAY_TYPE={CONTAINER:0,RECT:1,SPRITE:2},BLEND_MODE={SOURCE_OVER:["ONE","ONE_MINUS_SRC_ALPHA"],LIGHTER:["SRC_ALPHA","ONE"],DESTINATION_OUT:["ZERO","ONE_MINUS_SRC_ALPHA"],DESTINATION_IN:["ZERO","SRC_ALPHA"],ADD:["ONE","DST_ALPHA"],MULTIPLY:["DST_COLOR","ONE_MINUS_SRC_ALPHA"],SCREEN:["ONE","ONE_MINUS_SRC_COLOR"]},Util={emptyConstructor:function(){},inherit:function(t,e){Util.emptyConstructor.prototype=e.prototype,t.superClass=e.prototype,t.prototype=new Util.emptyConstructor,t.prototype.constructor=t},isMobile:function(){if(!window.navigator)return!0;var t=navigator.userAgent.toLowerCase();return-1!=t.indexOf("mobile")||-1!=t.indexOf("android")}},PI=Math.PI,HalfPI=PI/2,PacPI=PI+HalfPI,TwoPI=2*PI,DEG_TO_RAD=PI/180,Matrix=function(){this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0};Matrix._pool=[],Matrix.create=function(){return matrix=Matrix._pool.pop()||new Matrix},Matrix.release=function(t){t.identify(),Matrix._pool.push(t)},Matrix.prototype.identify=function(){this.a=this.d=1,this.b=this.c=this.tx=this.ty=0},Matrix.prototype.set=function(t,e,r,i,a,o){this.a=t,this.b=e,this.c=r,this.d=i,this.tx=a,this.ty=o},Matrix.prototype.rotate=function(t){if(t=+t,0!==t){var e=cos(t),r=sin(t),i=this.a,a=this.b,o=this.c,n=this.d,s=this.tx,h=this.ty;this.a=i*e-a*r,this.b=i*r+a*e,this.c=o*e-n*r,this.d=o*r+n*e,this.tx=s*e-h*r,this.ty=s*r+h*e}},Matrix.prototype.scale=function(t,e){1!==t&&(this.a*=t,this.c*=t,this.tx*=t),1!==e&&(this.b*=e,this.d*=e,this.ty*=e)},Matrix.prototype.translate=function(t,e){this.tx+=t,this.ty+=e},Matrix.prototype.append=function(t){var e=this.a,r=this.b,i=this.c,a=this.d,o=this.tx,n=this.ty;this.a=e*t.a+i*t.b,this.b=r*t.a+a*t.b,this.c=e*t.c+i*t.d,this.d=r*t.c+a*t.d,this.tx=e*t.tx+i*t.ty+o,this.ty=r*t.tx+a*t.ty+n},Matrix.prototype.prepend=function(t){var e=this.a,r=this.b,i=this.c,a=this.d,o=this.tx,n=this.ty;this.a=t.a*e+t.c*r,this.b=t.b*e+t.d*r,this.c=t.a*i+t.c*a,this.d=t.b*i+t.d*a,this.tx=t.a*o+t.c*n+t.tx,this.ty=t.b*o+t.d*n+t.ty},Matrix.prototype.copy=function(t){this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty},Matrix.prototype.invert=function(){var t=this.a,e=this.b,r=this.c,i=this.d,a=this.tx,o=this.ty;if(0==e&&0==r)return this.b=this.c=0,void(0==t||0==i?this.a=this.d=this.tx=this.ty=0:(t=this.a=1/t,i=this.d=1/i,this.tx=-t*a,this.ty=-i*o));var n=t*i-e*r;if(0==n)return void this.identity();n=1/n;var s=this.a=i*n;e=this.b=-e*n,r=this.c=-r*n,i=this.d=t*n,this.tx=-(s*a+r*o),this.ty=-(e*a+i*o)};var Rectangle=function(t,e,r,i){this.set(t,e,r,i)};Rectangle.prototype.set=function(t,e,r,i){this.x=t||0,this.y=e||0,this.width=r||0,this.height=i||0},Rectangle.prototype.copy=function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},Rectangle.prototype.contains=function(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height};var Texture=function(t){this.gl=t,this.width=0,this.height=0,this.isInit=!1,this.glTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.glTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)};Texture.prototype.uploadImage=function(t,e){var r=this.gl;e&&r.bindTexture(r.TEXTURE_2D,this.glTexture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t),this.width=t.width,this.height=t.height,this.isInit=!0},Texture.fromImage=function(t,e){var r=new Texture(t);return r.uploadImage(e),r},Texture.fromSrc=function(t,e){var r=new Texture(t),i=new Image;return i.src=e,i.onload=function(){r.uploadImage(i,!0)},r};var RenderTexture=function(t,e,r){RenderTexture.superClass.constructor.call(this,t),e&&r&&this.resize(e,r)};Util.inherit(RenderTexture,Texture),RenderTexture.prototype.resize=function(t,e,r){var i=this.gl;r&&i.bindTexture(i.TEXTURE_2D,this.glTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),this.width=t,this.height=e,this.isInit=!0};var DrawData=function(){this.cmd=null,this.texture=null,this.color=0,this.transform=null,this.count=0,this.blendMode="",this.filter=null,this.mask=null};DrawData.pool=[];for(var i=0;300>i;i++)DrawData.pool.push(new DrawData);DrawData.getObject=function(){return DrawData.pool.length>0?DrawData.pool.pop():new DrawData},DrawData.returnObject=function(t){t.cmd=null,t.texture=null,t.color=0,t.transform=null,t.count=0,t.blendMode="",t.filter=null,t.mask=null,DrawData.pool.push(t)};var Render=function(t){this.view=t,this.gl=t.getContext("webgl",{antialias:!1,stencil:!0}),this.width=t.clientWidth,this.height=t.clientHeight,this.rootRenderTarget=new RenderTarget(this.gl,this.width,this.height,!0),this.currentRenderTarget=null,this.activateRenderTarget(this.rootRenderTarget),this.rootRenderBuffer=new RenderBuffer(this.gl),this.currentRenderBuffer=null,this.activateRenderBuffer(this.rootRenderBuffer),this.textureShader=new TextureShader(this.gl),this.primitiveShader=new PrimitiveShader(this.gl),this.colorTransformShader=new ColorTransformShader(this.gl),this.currentShader=null,this.drawCall=0,this.defaultBlendMode=BLEND_MODE.SOURCE_OVER,this.filtersStack=[],this.maskCount=0;var e=this.gl;e.disable(e.STENCIL_TEST),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),this.setBlendMode(this.defaultBlendMode)};Object.defineProperties(Render.prototype,{context:{get:function(){return this.gl}}}),Render.prototype.activateShader=function(t){if(this.currentShader!=t){var e=this.gl;t.activate(e,this.width,this.height),this.currentShader=t}},Render.prototype.activateRenderTarget=function(t){this.currentRenderTarget!=t&&(t.activate(),this.currentRenderTarget=t)},Render.prototype.activateRenderBuffer=function(t){this.currentRenderBuffer!=t&&(t.activate(),this.currentRenderBuffer=t)},Render.prototype.render=function(t){return this.drawCall=0,this._render(t),this.flush(),this.drawCall},Render.prototype._render=function(t){this.currentRenderBuffer.reachedMaxSize()&&this.flush();var e=this.currentRenderBuffer.transform,r=Matrix.create();r.copy(e),e.append(t.getTransformMatrix()),t.blend!=this.defaultBlendMode&&this.currentRenderBuffer.cacheBlendMode(t.blend);var i=null;if(t.filters.length>0&&(i=Matrix.create(),i.copy(e),e.identify(),this.currentRenderBuffer.cacheFiltersPush(t.filters,t.width,t.height)),t.mask){var a=t.mask;this.currentRenderBuffer.reachedMaxSize()&&this.flush(),this.currentRenderBuffer.cacheQuad(a.x,a.y,a.width,a.height,e),this.currentRenderBuffer.cacheMaskPush(t.mask)}if(t.type==DISPLAY_TYPE.CONTAINER)for(var o=t.children.length,n=0;o>n;n++){var s=t.children[n];this._render(s)}else this.currentRenderBuffer.cache(t);if(t.blend!=this.defaultBlendMode&&this.currentRenderBuffer.cacheBlendMode(this.defaultBlendMode),t.mask){var a=t.mask;this.currentRenderBuffer.reachedMaxSize()&&this.flush(),this.currentRenderBuffer.cacheQuad(a.x,a.y,a.width,a.height,e),this.currentRenderBuffer.cacheMaskPop()}if(t.filters.length>0){for(var n=0;n<t.filters.length-1;n++)this.currentRenderBuffer.reachedMaxSize()&&this.flush(),this.currentRenderBuffer.cacheQuad(0,0,t.width,t.height,e);e.copy(i),Matrix.release(i),this.currentRenderBuffer.reachedMaxSize()&&this.flush(),this.currentRenderBuffer.cacheQuad(0,0,t.width,t.height,e),this.currentRenderBuffer.cacheFiltersPop()}e.copy(r),Matrix.release(r)},Render.prototype.flush=function(){this.drawWebGL(),this.currentRenderBuffer.clear()},Render.prototype.drawWebGL=function(){var t=this.gl;this.currentRenderBuffer.upload();for(var e=0,r=this.currentRenderBuffer.drawData,i=r.length,a=0;i>a;a++){var o=r[a];switch(o.cmd){case RENDER_CMD.TEXTURE:var n=o.count;o.texture&&o.texture.isInit&&(this.activateShader(this.textureShader),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o.texture.glTexture),t.drawElements(t.TRIANGLES,6*n,t.UNSIGNED_SHORT,2*e),this.drawCall++),e+=6*n;break;case RENDER_CMD.RECT:var n=o.count;this.activateShader(this.primitiveShader),this.primitiveShader.fillColor(t,o.color),t.drawElements(t.TRIANGLES,6*n,t.UNSIGNED_SHORT,2*e),this.drawCall++,e+=6*n;break;case RENDER_CMD.BLEND:var s=o.blendMode;this.setBlendMode(s);break;case RENDER_CMD.FILTERS_PUSH:var h=o.filters;0==this.filtersStack.length&&this.filtersStack.push({filters:null,renderTarget:this.currentRenderTarget});var c=RenderTarget.create(this.gl,o.width,o.height);this.filtersStack.push({filters:h,renderTarget:c}),this.activateRenderTarget(c);break;case RENDER_CMD.FILTERS_POP:var u=this.filtersStack.pop(),l=this.filtersStack[this.filtersStack.length-1],h=u.filters,d=h.length,p=u.renderTarget;if(d>1)for(var f=0;d-1>f;f++){var v=h[f],T=RenderTarget.create(t,p.width,p.height);e=v.applyFilter(this,p,T,e),RenderTarget.release(p),p=T}var v=h[h.length-1],c=l.renderTarget;e=v.applyFilter(this,p,c,e),RenderTarget.release(p);break;case RENDER_CMD.MASK_PUSH:var n=1;0==this.maskCount&&(t.enable(t.STENCIL_TEST),t.clear(t.STENCIL_BUFFER_BIT));var g=this.maskCount;this.maskCount++,t.colorMask(!1,!1,!1,!1),t.stencilFunc(t.EQUAL,g,255),t.stencilOp(t.KEEP,t.KEEP,t.INCR),this.activateShader(this.primitiveShader),this.primitiveShader.fillColor(t,0),t.drawElements(t.TRIANGLES,6*n,t.UNSIGNED_SHORT,2*e),t.stencilFunc(t.EQUAL,g+1,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),this.drawCall++,e+=6*n;break;case RENDER_CMD.MASK_POP:var n=1,g=this.maskCount;this.maskCount--,t.colorMask(!1,!1,!1,!1),t.stencilFunc(t.EQUAL,g,255),t.stencilOp(t.KEEP,t.KEEP,t.DECR),this.activateShader(this.primitiveShader),this.primitiveShader.fillColor(t,0),t.drawElements(t.TRIANGLES,6*n,t.UNSIGNED_SHORT,2*e),t.stencilFunc(t.EQUAL,g-1,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),0==this.maskCount&&t.disable(t.STENCIL_TEST),this.drawCall++,e+=6*n;break;default:console.warn("no render type function!")}}t.bindTexture(t.TEXTURE_2D,null)},Render.prototype.applyFilter=function(t,e,r,i){var a=this.gl;this.activateRenderTarget(r);var o=1;return a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,e.texture.glTexture),a.drawElements(a.TRIANGLES,6*o,a.UNSIGNED_SHORT,2*i),this.drawCall++,i+=6*o},Render.prototype.setBlendMode=function(t){var e=this.gl;t&&2==t.length?e.blendFunc(e[t[0]],e[t[1]]):console.log("blend mode not found!")},Render.prototype.clear=function(){this.currentRenderTarget.clear()};var RenderTarget=function(t,e,r,i){this.gl=t,this.root=i,this.frameBuffer=null,this.texture=null,this.width=e,this.height=r,this.clearColor=[0,0,0,0],this.root||(this.frameBuffer=t.createFramebuffer(),this.texture=new RenderTexture(t,e,r),t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture.glTexture,0))};RenderTarget._pool=[],RenderTarget.create=function(t,e,r){var i=RenderTarget._pool.pop();return i?(i.width==e&&i.height==r?i.clear(!0):i.resize(e,r),i):new RenderTarget(t,e,r)},RenderTarget.release=function(t){RenderTarget._pool.push(t)},RenderTarget.prototype.resize=function(t,e){this.width=t,this.height=e,this.texture.resize(t,e,!0)},RenderTarget.prototype.clear=function(t){var e=this.gl;t&&e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]),e.clear(e.COLOR_BUFFER_BIT)},RenderTarget.prototype.attachStencilBuffer=function(){},RenderTarget.prototype.activate=function(){var t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer)},RenderTarget.prototype.destroy=function(){};var RenderBuffer=function(t){this.gl=t,this.maxVertices=8e3,this.maxIndices=12e3,this.vertSize=4,this.verticesCount=0,this.indicesCount=0,this.drawData=[],this.vertices=new Float32Array(this.maxVertices*this.vertSize),this.vertexBuffer=t.createBuffer(),this.indices=new Uint16Array(this.maxIndices),this.indexBuffer=t.createBuffer(),this.transform=new Matrix};RenderBuffer.prototype.activate=function(){var t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer)},RenderBuffer.prototype.upload=function(){var t=this.gl,e=this.vertices.subarray(0,this.verticesCount*this.vertSize);t.bufferData(t.ARRAY_BUFFER,e,t.STREAM_DRAW);var r=this.indices.subarray(0,this.indicesCount);t.bufferData(t.ELEMENT_ARRAY_BUFFER,r,t.STATIC_DRAW)},RenderBuffer.prototype.reachedMaxSize=function(){return this.verticesCount>=this.maxVertices-4||this.indicesCount>=this.maxIndices-6},RenderBuffer.prototype.cache=function(t){var e=this.transform,r=t.getCoords(),i=t.getProps(),a=t.getIndices();this.cacheVerticesAndIndices(r,i,a,e);var o=t.type,n=null;switch(o){case DISPLAY_TYPE.SPRITE:(t.filters.length>0||0==this.drawData.length||this.drawData[this.drawData.length-1].cmd!=RENDER_CMD.TEXTURE||this.drawData[this.drawData.length-1].texture!=t.texture)&&(n=t.getDrawData(),n.cmd=RENDER_CMD.TEXTURE,this.drawData.push(n)),this.drawData[this.drawData.length-1].count++;break;case DISPLAY_TYPE.RECT:(t.filters.length>0||0==this.drawData.length||this.drawData[this.drawData.length-1].cmd!=RENDER_CMD.RECT||this.drawData[this.drawData.length-1].color!=t.color)&&(n=t.getDrawData(),n.cmd=RENDER_CMD.RECT,this.drawData.push(n)),this.drawData[this.drawData.length-1].count++;break;default:console.warn("no render type function")}},RenderBuffer.prototype.cacheBlendMode=function(t){if(this.drawData.length>0)for(var e=!1,r=this.drawData.length-1;r>=0;r--){var i=this.drawData[r];if(i.cmd!=RENDER_CMD.BLEND&&(e=!0),e||i.cmd!=RENDER_CMD.BLEND){if(i.cmd==RENDER_CMD.BLEND){if(i.blendMode==t)return;break}}else this.drawData.splice(r,1)}var i=DrawData.getObject();i.cmd=RENDER_CMD.BLEND,i.blendMode=t,this.drawData.push(i)},RenderBuffer.prototype.cacheFiltersPush=function(t,e,r){var i=DrawData.getObject();i.cmd=RENDER_CMD.FILTERS_PUSH,i.filters=t,i.width=e,i.height=r,this.drawData.push(i)},RenderBuffer.prototype.cacheFiltersPop=function(){var t=DrawData.getObject();t.cmd=RENDER_CMD.FILTERS_POP,this.drawData.push(t)},RenderBuffer.prototype.cacheMaskPush=function(t){var e=DrawData.getObject();e.cmd=RENDER_CMD.MASK_PUSH,e.mask=t,this.drawData.push(e)},RenderBuffer.prototype.cacheMaskPop=function(){var t=DrawData.getObject();t.cmd=RENDER_CMD.MASK_POP,this.drawData.push(t)},RenderBuffer.prototype.cacheQuad=function(t,e,r,i,a){var o=[t,e,t+r,e,t+r,e+i,t,e+i],n=[0,0,1,0,1,1,0,1],s=[0,1,2,2,3,0];this.cacheVerticesAndIndices(o,n,s,a)},RenderBuffer.prototype.cacheVerticesAndIndices=function(t,e,r,i){var a=2,o=this.vertSize-a,n=t.length/a;if(n!=e.length/o)return void console.log("coords size and props size cannot match!");for(var s=i,h=0,c=0,u=0;n>u;u++){h=t[u*a+0],c=t[u*a+1],this.vertices[(this.verticesCount+u)*this.vertSize+0]=s.a*h+s.c*c+s.tx,this.vertices[(this.verticesCount+u)*this.vertSize+1]=s.b*h+s.d*c+s.ty;for(var l=0;o>l;l++)this.vertices[(this.verticesCount+u)*this.vertSize+a+l]=e[u*o+l]}for(var u=0;u<r.length;u++)this.indices[this.indicesCount+u]=r[u]+this.verticesCount;this.verticesCount+=n,this.indicesCount+=r.length},RenderBuffer.prototype.clear=function(){for(var t=0;t<this.drawData.length;t++)DrawData.returnObject(this.drawData[t]);this.drawData.length=0,this.verticesCount=0,this.indicesCount=0};var Shader=function(t,e,r){this.vshaderSource=e,this.fshaderSource=r,this.vertexShader=this._loadShader(t,t.VERTEX_SHADER,this.vshaderSource),this.fragmentShader=this._loadShader(t,t.FRAGMENT_SHADER,this.fshaderSource),this.program=this._createProgram(t)};Shader.prototype.activate=function(t,e,r){t.useProgram(this.program);var i=t.getUniformLocation(this.program,"u_Projection");t.uniform2f(i,e/2,r/2)},Shader.prototype._createProgram=function(t){var e=t.createProgram();return t.attachShader(e,this.vertexShader),t.attachShader(e,this.fragmentShader),t.linkProgram(e),e},Shader.prototype._loadShader=function(t,e,r){var i=t.createShader(e);t.shaderSource(i,r),t.compileShader(i);var a=t.getShaderParameter(i,t.COMPILE_STATUS);return a||(console.log("shader not compiled!"),console.log(t.getShaderInfoLog(i))),i};var PrimitiveShader=function(t){var e=["attribute vec2 a_Position;","uniform vec2 u_Projection;","const vec2 center = vec2(1.0, 1.0);","void main() {","gl_Position = vec4(a_Position / u_Projection - center, 0.0, 1.0);","}"].join("\n"),r=["precision mediump float;","uniform vec4 u_Color;","void main() {","gl_FragColor = u_Color;","}"].join("\n");PrimitiveShader.superClass.constructor.call(this,t,e,r)};Util.inherit(PrimitiveShader,Shader),PrimitiveShader.prototype.activate=function(t,e,r){PrimitiveShader.superClass.activate.call(this,t,e,r);var i=t.getAttribLocation(this.program,"a_Position"),a=4;t.vertexAttribPointer(i,2,t.FLOAT,!1,4*a,0),t.enableVertexAttribArray(i),this.fillColor(t,16776960)},PrimitiveShader.prototype.fillColor=function(t,e){var r=t.getUniformLocation(this.program,"u_Color"),i=parseInt(e,10),a=i/65536,o=i%65536/256,n=i%256/1;t.uniform4f(r,a/256,o/256,n/256,1)};var TextureShader=function(t){var e=["attribute vec2 a_Position;","attribute vec2 a_TexCoord;","varying vec2 v_TexCoord;","uniform vec2 u_Projection;","const vec2 center = vec2(1.0, 1.0);","void main() {","gl_Position = vec4(a_Position / u_Projection - center, 0.0, 1.0);","v_TexCoord = a_TexCoord;","}"].join("\n"),r=["precision mediump float;","uniform sampler2D u_Sampler;","varying vec2 v_TexCoord;","void main() {","gl_FragColor = texture2D(u_Sampler, v_TexCoord);","}"].join("\n");TextureShader.superClass.constructor.call(this,t,e,r)};Util.inherit(TextureShader,Shader),TextureShader.prototype.activate=function(t,e,r){TextureShader.superClass.activate.call(this,t,e,r);var i=t.getAttribLocation(this.program,"a_Position"),a=t.getAttribLocation(this.program,"a_TexCoord"),o=4;t.vertexAttribPointer(i,2,t.FLOAT,!1,4*o,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(a,2,t.FLOAT,!1,4*o,2*o),t.enableVertexAttribArray(a);var n=t.getUniformLocation(this.program,"u_Sampler");t.uniform1i(n,0)};var ColorTransformShader=function(t){var e=["attribute vec2 a_Position;","attribute vec2 a_TexCoord;","varying vec2 v_TexCoord;","uniform vec2 u_Projection;","const vec2 center = vec2(1.0, 1.0);","void main() {","gl_Position = vec4(a_Position / u_Projection - center, 0.0, 1.0);","v_TexCoord = a_TexCoord;","}"].join("\n"),r=["precision mediump float;","uniform sampler2D u_Sampler;","varying vec2 v_TexCoord;","uniform mat4 u_Matrix;","uniform vec4 u_ColorAdd;","void main() {","vec4 texColor = texture2D(u_Sampler, v_TexCoord);","vec4 locColor = texColor * u_Matrix;","if (locColor.a != 0.0) {","locColor += u_ColorAdd * locColor.a;","}","gl_FragColor = locColor;","}"].join("\n");ColorTransformShader.superClass.constructor.call(this,t,e,r),this.transform=new Float32Array(16),this.colorAdd=new Float32Array(4)};Util.inherit(ColorTransformShader,Shader),ColorTransformShader.prototype.activate=function(t,e,r){ColorTransformShader.superClass.activate.call(this,t,e,r);var i=t.getAttribLocation(this.program,"a_Position"),a=t.getAttribLocation(this.program,"a_TexCoord"),o=4;t.vertexAttribPointer(i,2,t.FLOAT,!1,4*o,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(a,2,t.FLOAT,!1,4*o,2*o),t.enableVertexAttribArray(a);var n=t.getUniformLocation(this.program,"u_Sampler");t.uniform1i(n,0)},ColorTransformShader.prototype.setMatrix=function(t,e){var r=t.getUniformLocation(this.program,"u_Matrix"),i=t.getUniformLocation(this.program,"u_ColorAdd");this.transform[0]=e[0],this.transform[1]=e[1],this.transform[2]=e[2],this.transform[3]=e[3],this.transform[4]=e[5],this.transform[5]=e[6],this.transform[6]=e[7],this.transform[7]=e[8],this.transform[8]=e[10],this.transform[9]=e[11],this.transform[10]=e[12],this.transform[11]=e[13],this.transform[12]=e[15],this.transform[13]=e[16],this.transform[14]=e[17],this.transform[15]=e[18],this.colorAdd[0]=e[4]/255,this.colorAdd[1]=e[9]/255,this.colorAdd[2]=e[14]/255,this.colorAdd[3]=e[19]/255,t.uniformMatrix4fv(r,!1,this.transform),t.uniform4fv(i,this.colorAdd)};var GrayShader=function(t){var e=["attribute vec2 a_Position;","attribute vec2 a_TexCoord;","varying vec2 v_TexCoord;","uniform vec2 u_Projection;","const vec2 center = vec2(1.0, 1.0);","void main() {","gl_Position = vec4(a_Position / u_Projection - center, 0.0, 1.0);","v_TexCoord = a_TexCoord;","}"].join("\n"),r=["precision mediump float;","uniform sampler2D u_Sampler;","varying vec2 v_TexCoord;","void main() {","vec4 color = texture2D(u_Sampler, v_TexCoord);","float gray = (color.r + color.g + color.b) / 3.0;","gl_FragColor = vec4(gray, gray, gray, color.a);","}"].join("\n");GrayShader.superClass.constructor.call(this,t,e,r)};Util.inherit(GrayShader,Shader),GrayShader.prototype.activate=function(t,e,r){GrayShader.superClass.activate.call(this,t,e,r);var i=t.getAttribLocation(this.program,"a_Position"),a=t.getAttribLocation(this.program,"a_TexCoord"),o=4;t.vertexAttribPointer(i,2,t.FLOAT,!1,4*o,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(a,2,t.FLOAT,!1,4*o,2*o),t.enableVertexAttribArray(a);var n=t.getUniformLocation(this.program,"u_Sampler");t.uniform1i(n,0)};var BlurXShader=function(t){var e=["attribute vec2 a_Position;","attribute vec2 a_TexCoord;","varying vec2 v_TexCoord;","uniform vec2 u_Projection;","const vec2 center = vec2(1.0, 1.0);","void main() {","gl_Position = vec4(a_Position / u_Projection - center, 0.0, 1.0);","v_TexCoord = a_TexCoord;","}"].join("\n"),r=["precision mediump float;","uniform sampler2D u_Sampler;","varying vec2 v_TexCoord;","uniform float u_Blur;","uniform vec2 u_TextureSize;","void main() {","const int sampleRadius = 5;","const int samples = sampleRadius * 2 + 1;","vec4 color = vec4(0, 0, 0, 0);","for (int i = -sampleRadius; i <= sampleRadius; i++) {","color += texture2D(u_Sampler, v_TexCoord + vec2(float(i) * u_Blur / float(sampleRadius) / u_TextureSize.x, 0));","}","color /= float(samples);","gl_FragColor = color;","}"].join("\n");BlurXShader.superClass.constructor.call(this,t,e,r)};Util.inherit(BlurXShader,Shader),BlurXShader.prototype.activate=function(t,e,r){BlurXShader.superClass.activate.call(this,t,e,r);var i=t.getAttribLocation(this.program,"a_Position"),a=t.getAttribLocation(this.program,"a_TexCoord"),o=4;t.vertexAttribPointer(i,2,t.FLOAT,!1,4*o,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(a,2,t.FLOAT,!1,4*o,2*o),t.enableVertexAttribArray(a);var n=t.getUniformLocation(this.program,"u_Sampler");t.uniform1i(n,0)},BlurXShader.prototype.setBlurX=function(t,e){var r=t.getUniformLocation(this.program,"u_Blur");t.uniform1f(r,e)},BlurXShader.prototype.setTextureSize=function(t,e,r){var i=t.getUniformLocation(this.program,"u_TextureSize");t.uniform2f(i,e,r)};var BlurYShader=function(t){var e=["attribute vec2 a_Position;","attribute vec2 a_TexCoord;","varying vec2 v_TexCoord;","uniform vec2 u_Projection;","const vec2 center = vec2(1.0, 1.0);","void main() {","gl_Position = vec4(a_Position / u_Projection - center, 0.0, 1.0);","v_TexCoord = a_TexCoord;","}"].join("\n"),r=["precision mediump float;","uniform sampler2D u_Sampler;","varying vec2 v_TexCoord;","uniform float u_Blur;","uniform vec2 u_TextureSize;","void main() {","const int sampleRadius = 5;","const int samples = sampleRadius * 2 + 1;","vec4 color = vec4(0, 0, 0, 0);","for (int i = -sampleRadius; i <= sampleRadius; i++) {","color += texture2D(u_Sampler, v_TexCoord + vec2(0, float(i) * u_Blur / float(sampleRadius) / u_TextureSize.y));","}","color /= float(samples);","gl_FragColor = color;","}"].join("\n");BlurYShader.superClass.constructor.call(this,t,e,r)};Util.inherit(BlurYShader,Shader),BlurYShader.prototype.activate=function(t,e,r){BlurYShader.superClass.activate.call(this,t,e,r);var i=t.getAttribLocation(this.program,"a_Position"),a=t.getAttribLocation(this.program,"a_TexCoord"),o=4;t.vertexAttribPointer(i,2,t.FLOAT,!1,4*o,0),t.enableVertexAttribArray(i),t.vertexAttribPointer(a,2,t.FLOAT,!1,4*o,2*o),t.enableVertexAttribArray(a);var n=t.getUniformLocation(this.program,"u_Sampler");t.uniform1i(n,0)},BlurYShader.prototype.setBlurY=function(t,e){var r=t.getUniformLocation(this.program,"u_Blur");t.uniform1f(r,e)},BlurYShader.prototype.setTextureSize=function(t,e,r){var i=t.getUniformLocation(this.program,"u_TextureSize");t.uniform2f(i,e,r)};var AbstractFilter=function(t){this.shader=null};AbstractFilter.prototype.applyFilter=function(t,e,r,i){return i=t.applyFilter(this,e,r,i)};var ColorTransformFilter=function(t){this.shader=new ColorTransformShader(t),this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0]};Util.inherit(ColorTransformFilter,AbstractFilter),ColorTransformFilter.prototype.reset=function(){this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0]},ColorTransformFilter.prototype.brightness=function(t){this.matrix=[t,0,0,0,0,0,t,0,0,0,0,0,t,0,0,0,0,0,1,0]},ColorTransformFilter.prototype.grayScale=function(t){this.matrix=[t,t,t,0,0,t,t,t,0,0,t,t,t,0,0,0,0,0,1,0]},ColorTransformFilter.prototype.blackAndWhite=function(t){this.matrix=[.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0]},ColorTransformFilter.prototype.hue=function(t){t=(t||0)/180*Math.PI;var e=Math.cos(t),r=Math.sin(t),i=.213,a=.715,o=.072;this.matrix=[i+e*(1-i)+r*-i,a+e*-a+r*-a,o+e*-o+r*(1-o),0,0,i+e*-i+.143*r,a+e*(1-a)+.14*r,o+e*-o+r*-.283,0,0,i+e*-i+r*-(1-i),a+e*-a+r*a,o+e*(1-o)+r*o,0,0,0,0,0,1,0]},ColorTransformFilter.prototype.contrast=function(t){var e=(t||0)+1,r=-128*(e-1);this.matrix=[e,0,0,0,r,0,e,0,0,r,0,0,e,0,r,0,0,0,1,0]},ColorTransformFilter.prototype.saturate=function(t){var e=2*(t||0)/3+1,r=(e-1)*-.5;this.matrix=[e,r,r,0,0,r,e,r,0,0,r,r,e,0,0,0,0,0,1,0]},ColorTransformFilter.prototype.desaturate=function(t){this.saturate(-1)},ColorTransformFilter.prototype.negative=function(){this.matrix=[0,1,1,0,0,1,0,1,0,0,1,1,0,0,0,0,0,0,1,0]},ColorTransformFilter.prototype.applyFilter=function(t,e,r,i){return t.activateShader(this.shader),this.shader.setMatrix(t.gl,this.matrix),i=t.applyFilter(this,e,r,i)};var GrayFilter=function(t){this.shader=new GrayShader(t)};Util.inherit(GrayFilter,AbstractFilter),GrayFilter.prototype.applyFilter=function(t,e,r,i){return t.activateShader(this.shader),i=t.applyFilter(this,e,r,i)};var BlurXFilter=function(t){this.shader=new BlurXShader(t),this.blurX=1};Util.inherit(BlurXFilter,AbstractFilter),BlurXFilter.prototype.applyFilter=function(t,e,r,i){return t.activateShader(this.shader),this.shader.setBlurX(t.gl,this.blurX),this.shader.setTextureSize(t.gl,e.width,e.height),i=t.applyFilter(this,e,r,i)};var BlurYFilter=function(t){this.shader=new BlurYShader(t),this.blurY=1};Util.inherit(BlurYFilter,AbstractFilter),BlurYFilter.prototype.applyFilter=function(t,e,r,i){return t.activateShader(this.shader),this.shader.setBlurY(t.gl,this.blurY),this.shader.setTextureSize(t.gl,e.width,e.height),i=t.applyFilter(this,e,r,i)};var EventDispatcher=function(){this.eventMap={}};EventDispatcher.prototype.addEventListener=function(t,e,r){var i=this.eventMap[t];i||(i=this.eventMap[t]=[]),i.push({listener:e,thisObject:r})},EventDispatcher.prototype.removeEventListener=function(t,e,r){var i=this.eventMap[t];if(i)for(var a=0,o=i.length;o>a;a++){var n=i[a];if(n.listener==e&&n.thisObject==r){i.splice(a,1);break}}},EventDispatcher.prototype.dispatchEvent=function(t){this.notifyListener(t)},EventDispatcher.prototype.notifyListener=function(t){var e=this.eventMap[t.type];if(e)for(var r=0,i=e.length;i>r;r++){var a=e[r];a.listener.call(a.thisObject,t)}};var Event=function(){this.type="",this.target=null};Event.dispatchEvent=function(t,e){var r=new Event;r.type=e,r.target=t,t.dispatchEvent(r)};var TouchEvent=function(){TouchEvent.superClass.constructor.call(this),this.pageX=0,this.pageY=0,this.localX=0,this.localY=0};Util.inherit(TouchEvent,Event),TouchEvent.dispatchEvent=function(t,e,r,i){var a=new TouchEvent;a.type=e,a.target=t,a.pageX=r,a.pageY=i;var o=t.getInvertedConcatenatedMatrix(),n=o.a*r+o.c*i+o.tx,s=o.b*r+o.d*i+o.ty;a.localX=n,a.localY=s,t.dispatchEvent(a)},TouchEvent.TOUCH_TAP="touch_tap",TouchEvent.TOUCH_BEGIN="touch_begin",TouchEvent.TOUCH_MOVE="touch_move",TouchEvent.TOUCH_END="touch_end",TouchEvent.TOUCH_RELEASE_OUTSIDE="touch_release_outside";var DisplayObject=function(){DisplayObject.superClass.constructor.call(this),this.type=null,this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.anchorX=0,this.anchorY=0,this.transform=new Matrix,this.width=0,this.height=0,this.filters=[],this.blend=BLEND_MODE.SOURCE_OVER,this.mask=null,this._contentBounds=new Rectangle,this.parent=null,this.concatenatedMatrix=new Matrix,this.invertConcatenatedMatrix=new Matrix};Util.inherit(DisplayObject,EventDispatcher),DisplayObject.prototype.getCoords=function(){},DisplayObject.prototype.getProps=function(){},DisplayObject.prototype.getIndices=function(){},DisplayObject.prototype.getDrawData=function(t){},DisplayObject.prototype.getTransformMatrix=function(){return this.transform.identify(),this.transform.translate(-this.anchorX*this.width,-this.anchorY*this.height),this.transform.scale(this.scaleX,this.scaleY),this.transform.rotate(this.rotation),this.transform.translate(this.x,this.y),this.transform},DisplayObject.prototype.getContentBounds=function(){var t=this._contentBounds;return t.x=0,t.y=0,t.width=this.width,t.height=this.height,this._contentBounds},DisplayObject.prototype.hitTest=function(t,e){var r=this.getContentBounds(),i=this.getInvertedConcatenatedMatrix(),a=i.a*t+i.c*e+i.tx,o=i.b*t+i.d*e+i.ty;return r.contains(a,o)?this:null},DisplayObject.prototype.dispatchEvent=function(t){for(var e=this.getPropagationList(),r=0;r<e.length;r++){var i=e[r];i.notifyListener(t)}},DisplayObject.prototype.getPropagationList=function(){for(var t=[],e=this;e;)t.push(e),e=e.parent;return t},DisplayObject.prototype.getConcatenatedMatrix=function(){return this.concatenatedMatrix.copy(this.getTransformMatrix()),this.parent&&this.concatenatedMatrix.prepend(this.parent.getConcatenatedMatrix()),this.concatenatedMatrix},DisplayObject.prototype.getInvertedConcatenatedMatrix=function(){return this.invertConcatenatedMatrix.copy(this.getConcatenatedMatrix()),this.invertConcatenatedMatrix.invert(),this.invertConcatenatedMatrix};var DisplayObjectContainer=function(){DisplayObjectContainer.superClass.constructor.call(this),this.type=DISPLAY_TYPE.CONTAINER,this.children=[]};Util.inherit(DisplayObjectContainer,DisplayObject),DisplayObjectContainer.prototype.addChild=function(t){this.children.push(t),t.parent=this},DisplayObjectContainer.prototype.removeChild=function(t){for(var e=0;e<this.children.length;){var r=this.children[e];if(r==t){this.children.splice(e,1),r.parent=null;break}e++}},DisplayObjectContainer.prototype.hitTest=function(t,e){for(var r=null,i=this.children.length-1;i>=0;i--){var a=this.children[i];if(r=a.hitTest(t,e))break}return r||DisplayObjectContainer.superClass.hitTest.call(this)};var Sprite=function(){Sprite.superClass.constructor.call(this),this.type=DISPLAY_TYPE.SPRITE,this.texture=null,this.sourceFrameSet=!1,this.sourceFrame=new Rectangle};Util.inherit(Sprite,DisplayObject),Sprite.prototype.setSourceFrame=function(t,e,r,i){this.sourceFrameSet=!0,1==arguments.length?this.sourceFrame.copy(t):this.sourceFrame.set(t,e,r,i)},Sprite.prototype.getCoords=function(){var t=[0,0,0+this.width,0,0+this.width,0+this.height,0,0+this.height];return t},Sprite.prototype.getProps=function(){var t=!1,e=0,r=0;this.texture&&(t=this.texture.isInit,e=this.texture.width,r=this.texture.height),this.sourceFrameSet||t&&this.setSourceFrame(0,0,e,r);var i=this.sourceFrame.x/e,a=this.sourceFrame.y/r,o=this.sourceFrame.width/e,n=this.sourceFrame.height/r,s=[i,a,i+o,a,i+o,a+n,i,a+n];return s},Sprite.prototype.getIndices=function(){return[0,1,2,2,3,0]},Sprite.prototype.getDrawData=function(){
var t=DrawData.getObject();return t.texture=this.texture,t.filters=this.filters,t};var Rect=function(){Rect.superClass.constructor.call(this),this.type=DISPLAY_TYPE.RECT,this.color=0};Util.inherit(Rect,DisplayObject),Rect.prototype.getCoords=function(){var t=[0,0,0+this.width,0,0+this.width,0+this.height,0,0+this.height];return t},Rect.prototype.getProps=function(){var t=[0,0,0,0,0,0,0,0];return t},Rect.prototype.getIndices=function(){return[0,1,2,2,3,0]},Rect.prototype.getDrawData=function(){var t=DrawData.getObject();return t.color=this.color,t};var State=function(){this.startTime=Date.now(),this.frameCount=0,this.dom=document.createElement("div"),this.dom.style.cssText="background:rgba(0, 0, 0, 0.8);position:absolute;top:0;left:0;padding:10px;min-width:180px;height:80px;fontSize:26px;color:green"};State.prototype.update=function(t){var e=Date.now();if(e-this.startTime<1e3)this.frameCount++;else{var r=Math.min(this.frameCount+1,60);this.show(r,t||"[not input!]"),this.startTime=e,this.frameCount=0}},State.prototype.show=function(t,e){this.dom.innerHTML="FPS :"+t+"</br>DRAW:"+e},State.prototype.getDom=function(){return this.dom};var TouchHandler=function(t,e){this.canvas=t,this.rootTarget=e,this.touchDownTarget={},this.useTouchesCount=0,this.maxTouches=6};TouchHandler.prototype.addListeners=function(){window.navigator.msPointerEnabled?this.addMSPointerListener():Util.isMobile()?this.addTouchListener():this.addMouseListener()},TouchHandler.prototype.addMSPointerListener=function(){var t=this;this.canvas.addEventListener("MSPointerDown",function(e){e.identifier=e.pointerId,t.onTouchBegin(e),t.prevent(e)},!1),this.canvas.addEventListener("MSPointerMove",function(e){e.identifier=e.pointerId,t.onTouchMove(e),t.prevent(e)},!1),this.canvas.addEventListener("MSPointerUp",function(e){e.identifier=e.pointerId,t.onTouchEnd(e),t.prevent(e)},!1)},TouchHandler.prototype.addMouseListener=function(){this.canvas.addEventListener("mousedown",this.onTouchBegin.bind(this)),this.canvas.addEventListener("mousemove",this.onTouchMove.bind(this)),this.canvas.addEventListener("mouseup",this.onTouchEnd.bind(this))},TouchHandler.prototype.addTouchListener=function(){var t=this;this.canvas.addEventListener("touchstart",function(e){for(var r=e.changedTouches.length,i=0;r>i;i++)t.onTouchBegin(e.changedTouches[i]);t.prevent(e)},!1),this.canvas.addEventListener("touchmove",function(e){for(var r=e.changedTouches.length,i=0;r>i;i++)t.onTouchMove(e.changedTouches[i]);t.prevent(e)},!1),this.canvas.addEventListener("touchend",function(e){for(var r=e.changedTouches.length,i=0;r>i;i++)t.onTouchEnd(e.changedTouches[i]);t.prevent(e)},!1),this.canvas.addEventListener("touchcancel",function(e){for(var r=e.changedTouches.length,i=0;r>i;i++)t.onTouchEnd(e.changedTouches[i]);t.prevent(e)},!1)},TouchHandler.prototype.prevent=function(t){t.stopPropagation(),1==t.isScroll||this.canvas.userTyping||t.preventDefault()},TouchHandler.prototype.onTouchBegin=function(t){if(!(this.useTouchesCount>=this.maxTouches)){var e=+t.identifyer||0,r=t.pageX,i=this.canvas.height-t.pageY,a=this.rootTarget.hitTest(r,i);a&&(null==this.touchDownTarget[e]&&(this.touchDownTarget[e]=a,this.useTouchesCount++),TouchEvent.dispatchEvent(a,TouchEvent.TOUCH_BEGIN,r,i))}},TouchHandler.prototype.onTouchMove=function(t){var e=+t.identifyer||0;if(null!=this.touchDownTarget[e]){var r=t.pageX,i=this.canvas.height-t.pageY,a=this.rootTarget.hitTest(r,i);a&&TouchEvent.dispatchEvent(a,TouchEvent.TOUCH_MOVE,r,i)}},TouchHandler.prototype.onTouchEnd=function(t){var e=+t.identifyer||0;if(null!=this.touchDownTarget[e]){var r=t.pageX,i=this.canvas.height-t.pageY,a=this.rootTarget.hitTest(r,i),o=this.touchDownTarget[e];delete this.touchDownTarget[e],this.useTouchesCount--,a&&TouchEvent.dispatchEvent(a,TouchEvent.TOUCH_END,r,i),a==o?TouchEvent.dispatchEvent(a,TouchEvent.TOUCH_TAP,r,i):TouchEvent.dispatchEvent(o,TouchEvent.TOUCH_RELEASE_OUTSIDE,r,i)}};